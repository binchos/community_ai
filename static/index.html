<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Community Board</title>
  <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-gray-50 min-h-screen">
  <!-- í—¤ë” -->
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
    <div class="max-w-4xl mx-auto px-4 h-14 flex items-center justify-between">
      <h1 class="text-lg font-bold text-gray-900 cursor-pointer" onclick="location.href='index.html'">Community</h1>
      <div id="navRight" class="flex items-center gap-2">
        <!-- JSì—ì„œ ë¡œê·¸ì¸ ì—¬ë¶€ì— ë”°ë¼ ë²„íŠ¼ êµì²´ -->
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-8">
    <!-- ìƒˆ ê¸€ ì‘ì„± -->
    <div class="flex justify-end">
      <button
        class="rounded-xl bg-blue-600 text-white px-4 py-2 font-medium hover:bg-blue-700"
        onclick="location.href='post.html'">
        âœï¸ ìƒˆ ê¸€ ì‘ì„±
      </button>
    </div>

    <h2 class="text-xl font-semibold text-gray-900 mt-6 mb-3">ìµœê·¼ ê¸€</h2>

    <div id="posts" class="space-y-3"></div>
      <div id="sentinel" class="h-10"></div>
  </main>

  <script>
  async function renderHeader() {
    const nav = document.getElementById('navRight');
    try {
      const res = await fetch('/users/me');
      if (!res.ok) {
        nav.innerHTML = `
          <button class="rounded-xl border px-3 py-1.5 text-sm hover:bg-gray-50" onclick="location.href='login.html'">ë¡œê·¸ì¸</button>
          <button class="rounded-xl bg-gray-900 text-white px-3 py-1.5 text-sm hover:bg-black" onclick="location.href='register.html'">íšŒì›ê°€ì…</button>
        `;
        return;
      }
      const { user } = await res.json();
      const avatar = user.avatar_url || 'https://cdn-icons-png.flaticon.com/512/3177/3177440.png';
      nav.innerHTML = `
        <button onclick="location.href='mypage.html'" class="flex items-center gap-2 rounded-full border px-2 py-1.5 hover:bg-gray-50">
          <img src="${avatar}" class="w-7 h-7 rounded-full object-cover">
          <span class="text-sm font-medium text-gray-800">${user.username}</span>
        </button>
      `;
    } catch {
      nav.innerHTML = `<button class="rounded-xl border px-3 py-1.5 text-sm" onclick="location.href='login.html'">ë¡œê·¸ì¸</button>`;
    }
  }

  // âœ… ì»¤ì„œ í˜ì´ì§• ìƒíƒœ
  let nextCursor = null;   // ë‹¤ìŒ ìš”ì²­ì— ë„˜ê¸¸ cursor (ë§ˆì§€ë§‰ ê¸€ id)
  let loading = false;     // ì¤‘ë³µìš”ì²­ ë°©ì§€
  let done = false;        // ë” ê°€ì ¸ì˜¬ ê²Œ ì—†ëŠ” ìƒíƒœ
  const LIMIT = 10;

  function renderPostCard(p) {
    const ts = p.created_date ? new Date(p.created_date).toLocaleString() : '';
    const avatar = p.author_avatar || 'https://cdn-icons-png.flaticon.com/512/3177/3177440.png';

    const el = document.createElement('article');
    el.className = 'bg-white rounded-xl border p-5 cursor-pointer hover:bg-gray-50 transition';
    el.innerHTML = `
      <!-- ì‘ì„±ì ë©”íƒ€ (ì•„ë°”íƒ€/ë‹‰ë„¤ì„/ì‹œê°„) -->
      <div class="flex items-center gap-3">
        <img src="${avatar}" class="w-8 h-8 rounded-full object-cover" alt="avatar">
        <div>
          <div class="text-sm font-medium text-gray-800">${p.username || '-'}</div>
          <div class="text-xs text-gray-500">${ts}</div>
        </div>
      </div>

      <h3 class="mt-3 text-lg font-semibold text-blue-700">${p.title}</h3>
      <p class="mt-1 text-gray-700 whitespace-pre-line">${p.content}</p>

      <div class="mt-3 flex items-center gap-4 text-sm text-gray-500">
        <span>ğŸ‘ ${p.like_count ?? 0}</span>
        <span>ğŸ’¬ ${p.comment_count ?? 0}</span>
        <span>ğŸ‘ï¸ ${p.view_count ?? 0}</span>
      </div>
    `;
    el.addEventListener('click', () => location.href = `post_detail.html?id=${p.id}`);
    return el;
  }

 async function loadMore() {
  if (loading || done) return;
  loading = true;

  const box = document.getElementById('posts');
  const sentinel = document.getElementById('sentinel');

  // ë¡œë”© í‘œì‹œ
  sentinel.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';

  try {
    const qs = new URLSearchParams({ limit: String(LIMIT) });
    if (nextCursor) qs.set('cursor', String(nextCursor));

    const res = await fetch(`/posts?${qs.toString()}`);
    if (!res.ok) {
      if (res.status === 401) {
        box.innerHTML = `
          <div class="bg-white rounded-xl border p-6 text-center text-gray-500">
            ğŸ”’ ë¡œê·¸ì¸ í›„ ê²Œì‹œê¸€ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>`;
        observer.disconnect?.();
        done = true;
        // ë¬¸êµ¬ ëŒ€ì‹  ì„¼í‹°ë„¬ ì œê±°
        sentinel.remove();
        return;
      }
      throw new Error('load failed');
    }

    const data = await res.json();
    const list = data.posts || [];

    // ì²« í˜ì´ì§€ê°€ ë¹„ì—ˆì„ ë•Œ
    if (!nextCursor && list.length === 0) {
      box.innerHTML = `
        <div class="bg-white rounded-xl border p-6 text-center text-gray-500">
          ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>`;
      done = true;
      observer.disconnect?.();
      sentinel.remove(); // âœ… ë¬¸êµ¬ ëŒ€ì‹  ê·¸ëƒ¥ ì—†ì•°
      return;
    }

    // ì¹´ë“œ ì¶”ê°€
    list.forEach(p => box.appendChild(renderPostCard(p)));

    // ë‹¤ìŒ ì»¤ì„œ ê°±ì‹ 
    nextCursor = data.next_cursor || null;

    if (!nextCursor) {
      // âœ… ë” ì—†ìœ¼ë©´ ë¬¸êµ¬ ì—†ì´ ì¡°ìš©íˆ ì¢…ë£Œ
      done = true;
      observer.disconnect?.();
      sentinel.remove();
    } else {
      sentinel.textContent = ''; // ë‹¤ìŒ ë¡œë“œë¥¼ ê¸°ë‹¤ë¦¼
    }
  } catch (e) {
    // ì˜¤ë¥˜ ë¬¸êµ¬ë„ ì‹«ë‹¤ë©´ ì•„ë˜ ì¤„ì„ sentinel.remove()ë¡œ ë°”ê¿”ë„ ë©ë‹ˆë‹¤.
    sentinel.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
  } finally {
    loading = false;
  }
}


  // âœ… IntersectionObserverë¡œ ë¬´í•œ ìŠ¤í¬ë¡¤
  let observer;
  function setupObserver() {
    const sentinel = document.getElementById('sentinel');
    observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) loadMore();
      });
    }, { rootMargin: '200px 0px' }); // ë¯¸ë¦¬ ë¡œë“œ
    observer.observe(sentinel);
  }

  (async function init() {
    await renderHeader();
    setupObserver();
    // ì²« í˜ì´ì§€ ë¡œë“œ
    await loadMore();
  })();
</script>

</body>
</html>
