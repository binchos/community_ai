<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Community Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- 헤더 -->
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
    <div class="max-w-4xl mx-auto px-4 h-14 flex items-center justify-between">
      <h1 class="text-lg font-bold text-gray-900 cursor-pointer" onclick="location.href='index.html'">Community</h1>
      <div id="navRight" class="flex items-center gap-2">
        <!-- JS에서 로그인 여부에 따라 버튼 교체 -->
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-8">
    <!-- 새 글 작성 -->
    <div class="flex justify-end">
      <button
        class="rounded-xl bg-blue-600 text-white px-4 py-2 font-medium hover:bg-blue-700"
        onclick="location.href='post.html'">
        ✏️ 새 글 작성
      </button>
    </div>

    <h2 class="text-xl font-semibold text-gray-900 mt-6 mb-3">최근 글</h2>

    <div id="posts" class="space-y-3"></div>
  </main>

  <script>
    async function renderHeader() {
      const nav = document.getElementById('navRight');
      try {
        const res = await fetch('/users/me');
        if (!res.ok) {
          nav.innerHTML = `
            <button class="rounded-xl border px-3 py-1.5 text-sm hover:bg-gray-50" onclick="location.href='login.html'">로그인</button>
            <button class="rounded-xl bg-gray-900 text-white px-3 py-1.5 text-sm hover:bg-black" onclick="location.href='register.html'">회원가입</button>
          `;
          return;
        }
        const { user } = await res.json();
        const avatar = user.avatar_url || 'https://cdn-icons-png.flaticon.com/512/3177/3177440.png';
        nav.innerHTML = `
          <button onclick="location.href='mypage.html'" class="flex items-center gap-2 rounded-full border px-2 py-1.5 hover:bg-gray-50">
            <img src="${avatar}" class="w-7 h-7 rounded-full object-cover">
            <span class="text-sm font-medium text-gray-800">${user.username}</span>
          </button>
        `;
      } catch {
        nav.innerHTML = `<button class="rounded-xl border px-3 py-1.5 text-sm" onclick="location.href='login.html'">로그인</button>`;
      }
    }

    async function loadPosts() {
      const box = document.getElementById('posts');
      try {
        const res = await fetch('/posts');
        if (!res.ok) {
          box.innerHTML = `
            <div class="bg-white rounded-xl border p-6 text-center text-gray-500">
              🔒 로그인 후 게시글을 볼 수 있습니다.
            </div>`;
          return;
        }
        const data = await res.json();
        if (!data.posts?.length) {
          box.innerHTML = `
            <div class="bg-white rounded-xl border p-6 text-center text-gray-500">
              아직 게시글이 없습니다.
            </div>`;
          return;
        }
        box.innerHTML = '';
        data.posts.forEach(p => {
            const ts = p.created_date ? new Date(p.created_date).toLocaleString() : '';
            const avatar = p.author_avatar || 'https://cdn-icons-png.flaticon.com/512/3177/3177440.png';

            const el = document.createElement('article');
            el.className = 'bg-white rounded-xl border p-5';

            el.innerHTML = `
    <!-- 작성자 메타 (아바타/닉네임/시간) -->
             <div class="flex items-center gap-3">
                 <img src="${avatar}" class="w-8 h-8 rounded-full object-cover" alt="avatar">
                 <div>
                  <div class="text-sm font-medium text-gray-800">${p.username || '-'}</div>
                  <div class="text-xs text-gray-500">${ts}</div>
                </div>
            </div>

            <h3 class="mt-3 text-lg font-semibold text-blue-700">${p.title}</h3>
            <p class="mt-1 text-gray-700 whitespace-pre-line">${p.content}</p>

           <div class="mt-3 flex items-center gap-4 text-sm text-gray-500">
             <span>👍 ${p.like_count ?? 0}</span>
              <span>💬 ${p.comment_count ?? 0}</span>
               <span>👁️ ${p.view_count ?? 0}</span>
             </div>
  `;

  el.classList.add('cursor-pointer','hover:bg-gray-50','transition');
  el.addEventListener('click', () => location.href = `post_detail.html?id=${p.id}`);
  box.appendChild(el);
});

      } catch {
        box.innerHTML = `<div class="bg-white rounded-xl border p-6 text-center text-red-500">게시글을 불러오는 중 오류가 발생했습니다.</div>`;
      }
    }

    (async function init() {
      await renderHeader();
      await loadPosts();
    })();
  </script>
</body>
</html>
