<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²Œì‹œê¸€ ìƒì„¸ Â· Community</title>
  <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-gray-50 min-h-screen">
  <!-- í—¤ë” -->
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
    <div class="max-w-4xl mx-auto px-4 h-14 flex items-center justify-between">
      <h1 class="text-lg font-bold text-gray-900 cursor-pointer" onclick="location.href='index.html'">Community</h1>
      <div id="navRight" class="flex items-center gap-2"></div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-8">
    <div class="mb-4">
      <button class="text-sm text-gray-600 hover:text-blue-700" onclick="location.href='index.html'">â† í™ˆìœ¼ë¡œ</button>

    </div>

    <!-- ë³¸ë¬¸ ì¹´ë“œ -->
    <article class="bg-white rounded-2xl border p-6">
    <div id="meta" class="flex items-center gap-3">
  <img id="authorAvatar" class="w-8 h-8 rounded-full object-cover" alt="author avatar">
  <div>
    <div id="author" class="text-sm font-medium text-gray-800">-</div>
    <div id="createdAt" class="text-xs text-gray-500">-</div>
  </div>
</div>


      <h2 id="title" class="mt-2 text-2xl font-bold text-gray-900 break-words">ì œëª©</h2>
 <div id="content" class="mt-6 whitespace-pre-line text-gray-800"></div>
        <div id="imageArea" class="mt-3"></div>
      <!-- ìƒë‹¨ í†µê³„ / ì¢‹ì•„ìš” ë²„íŠ¼ -->
      <div class="mt-3 flex items-center justify-between">
        <div class="flex items-center gap-4 text-sm text-gray-500">
          <span id="statLikes">ğŸ‘ 0</span>
          <span id="statComments">ğŸ’¬ 0</span>
          <span id="statViews">ğŸ‘ï¸ 0</span>
        </div>
     <div class="flex items-center gap-2">
    <button id="likeBtn"
            class="rounded-xl px-4 py-2 text-sm font-medium border hover:bg-gray-50">
      ğŸ‘ ì¢‹ì•„ìš”
    </button>

    <!-- âœ… ì‚­ì œ ë²„íŠ¼: ê¸°ë³¸ hidden, ì‘ì„±ìì¼ ë•Œë§Œ ë³´ì´ê²Œ -->
    <button id="deleteBtn"
            class="hidden rounded-xl px-4 py-2 text-sm font-medium border text-red-600 hover:bg-red-50">
      ğŸ—‘ ì‚­ì œ
    </button>
  </div>
      </div>


    </article>

    <!-- ëŒ“ê¸€ -->
    <section class="mt-6 bg-white rounded-2xl border p-6">
      <h3 class="text-lg font-semibold">ëŒ“ê¸€</h3>

      <!-- ëŒ“ê¸€ ì‘ì„± -->
      <form id="commentForm" class="mt-4">
        <textarea name="content"
                  class="w-full rounded-xl border px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
        <div class="mt-3 flex justify-end">
          <button class="rounded-xl bg-blue-600 text-white px-4 py-2 font-medium hover:bg-blue-700">
            ë“±ë¡
          </button>
        </div>
      </form>

      <!-- ëª©ë¡ -->
      <div id="comments" class="mt-4 space-y-3"></div>
    </section>
  </main>

  <script>
        window.addEventListener("pageshow", (e) => {
    if (e.persisted) location.reload();
  });
    // ê³µí†µ: í—¤ë” ìœ ì € í‘œì‹œ
    async function renderHeader() {
      const nav = document.getElementById('navRight');
      try {
        const res = await fetch('/users/me');
        if (!res.ok) {
          nav.innerHTML = `
            <button class="rounded-xl border px-3 py-1.5 text-sm hover:bg-gray-50" onclick="location.href='login.html'">ë¡œê·¸ì¸</button>
            <button class="rounded-xl bg-gray-900 text-white px-3 py-1.5 text-sm hover:bg-black" onclick="location.href='register.html'">íšŒì›ê°€ì…</button>
          `;
          return;
        }
        const { user } = await res.json();
        window.currentUser = user;

        const avatar = user.avatar_url || 'https://cdn-icons-png.flaticon.com/512/3177/3177440.png';
        nav.innerHTML = `
          <button onclick="location.href='mypage.html'" class="flex items-center gap-2 rounded-full border px-2 py-1.5 hover:bg-gray-50">
            <img src="${avatar}" class="w-7 h-7 rounded-full object-cover">
            <span class="text-sm font-medium text-gray-800">${user.username}</span>
          </button>
        `;
      } catch {
        nav.innerHTML = `<button class="rounded-xl border px-3 py-1.5 text-sm" onclick="location.href='login.html'">ë¡œê·¸ì¸</button>`;
      }
    }

    // URL íŒŒë¼ë¯¸í„°ì—ì„œ id ì¶”ì¶œ
    const params = new URLSearchParams(location.search);
    const postId = Number(params.get('id'));
    if (!postId) location.replace('index.html');

    // ìƒì„¸ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadPost() {
      // ì¡°íšŒìˆ˜ +1 (ë°±ì—”ë“œì— ë¼ìš°íŠ¸ í•„ìš”: POST /posts/{id}/view)
      try { await fetch(`/posts/${postId}/view`, { method: 'POST' }); } catch {}

      // ê²Œì‹œê¸€ ê°€ì ¸ì˜¤ê¸° (ê¶Œì¥ ë¼ìš°íŠ¸: GET /posts/{id} -> like_count, comment_count, view_count, liked í¬í•¨)
      let post;
      try {
        const r = await fetch(`/posts/${postId}`);
        if (r.ok) {
          post = await r.json();
        }
      } catch {}

      // ë§Œì•½ ìœ„ ë¼ìš°íŠ¸ê°€ ì—†ë‹¤ë©´, /posts ì „ì²´ì—ì„œ ì°¾ì•„ì„œ ìµœì†Œ ì •ë³´ë¼ë„ ë Œë” (í´ë°±)
      if (!post?.id) {
        try {
          const r2 = await fetch('/posts');
          if (r2.ok) {
            const data = await r2.json();
            post = (data.posts || []).find(p => p.id === postId);
            // liked ì •ë³´ëŠ” ì—†ìŒ (ë²„íŠ¼ ê¸°ë³¸ìƒíƒœë¡œ)
          }
        } catch {}
      }

      if (!post?.id) {
        document.querySelector('main').innerHTML =
          `<div class="max-w-4xl mx-auto bg-white rounded-xl border p-6 text-center text-red-500">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      // ë Œë”
      // ì œëª©/ë³¸ë¬¸
        document.getElementById('title').textContent = post.title || '-';
        document.getElementById('content').textContent = post.content || '';
        const imageArea = document.getElementById('imageArea');
if (post.image_url) {
  imageArea.innerHTML = `
    <img src="${post.image_url}"
         alt=""
         class="w-full rounded-xl border object-contain max-h-[28rem]">
  `;
} else {
  imageArea.innerHTML = ''; // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ë¹„ì›€
}
// ì•„ë°”íƒ€/ì´ë¦„/ì‹œê°„ â€” í™ˆ ëª©ë¡ê³¼ ë™ì¼í•œ í˜•íƒœ
        const avatar = post.author_avatar || 'https://cdn-icons-png.flaticon.com/512/3177/3177440.png';
        const avatarEl = document.getElementById('authorAvatar');
        if (avatarEl) {
  avatarEl.src = avatar;
  avatarEl.alt = post.username || 'author';
}
        document.getElementById('author').textContent =
  post.username || '-';
        document.getElementById('createdAt').textContent =
  post.created_date ? new Date(post.created_date).toLocaleString() : '';

      document.getElementById('statLikes').textContent    = `ğŸ‘ ${post.like_count ?? 0}`;
      document.getElementById('statComments').textContent = `ğŸ’¬ ${post.comment_count ?? 0}`;
      document.getElementById('statViews').textContent    = `ğŸ‘ï¸ ${post.view_count ?? 0}`;

      // ì¢‹ì•„ìš” ë²„íŠ¼ ìƒíƒœ
      setLikeBtn(!!post.liked);
      const deleteBtn = document.getElementById('deleteBtn');
        if (window.currentUser && window.currentUser.username && post.username && window.currentUser.username === post.username) {deleteBtn.classList.remove('hidden');
        deleteBtn.onclick = async () => {
            if (!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
            try {
                const r = await fetch(`/posts/${postId}`, { method: 'DELETE' });
                const data = await r.json().catch(()=>({}));
                if (!r.ok) {
                    alert(data.detail || 'ì‚­ì œ ì‹¤íŒ¨');
                    return;
                }
                alert(data.message || 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.href = 'index.html';
                } catch {
                alert('ì‚­ì œ ì‹¤íŒ¨');
                }
            };
        }
      // ë²„íŠ¼ í•¸ë“¤ëŸ¬
      document.getElementById('likeBtn').onclick = async () => {
        try {
          // ê¶Œì¥ ë¼ìš°íŠ¸: POST /posts/{id}/like (í† ê¸€) -> { liked:bool, like_count:int }
          const r = await fetch(`/posts/${postId}/like`, { method: 'POST' });
          if (!r.ok) return;
          const data = await r.json();
          setLikeBtn(!!data.liked);
          document.getElementById('statLikes').textContent = `ğŸ‘ ${data.like_count ?? (post.like_count ?? 0)}`;
        } catch {}
      };
    }

    function setLikeBtn(liked) {
      const btn = document.getElementById('likeBtn');
      if (liked) {
        btn.classList.remove('border','hover:bg-gray-50');
        btn.classList.add('bg-blue-600','text-white','hover:bg-blue-700');
        btn.textContent = 'ğŸ‘ ì¢‹ì•„ìš” ì·¨ì†Œ';
      } else {
        btn.classList.add('border','hover:bg-gray-50');
        btn.classList.remove('bg-blue-600','text-white','hover:bg-blue-700');
        btn.textContent = 'ğŸ‘ ì¢‹ì•„ìš”';
      }
    }

    // ëŒ“ê¸€
    async function loadComments() {
    const box = document.getElementById('comments');
    box.innerHTML = `<div class="text-sm text-gray-400">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>`;
    try {
      const r = await fetch(`/comments/${postId}`);
      if (!r.ok) throw 0;
      const data = await r.json();

      if (!data.comments?.length) {
        box.innerHTML = `<div class="text-sm text-gray-400">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”.</div>`;
        // ìƒë‹¨ ê°œìˆ˜ë„ 0ìœ¼ë¡œ
        document.getElementById('statComments').textContent = `ğŸ’¬ 0`;
        return;
      }

      box.innerHTML = '';
      data.comments.forEach(c => {
        const ts = c.created_date ? new Date(c.created_date).toLocaleString() : '';
        const isMine = window.currentUser && (c.user_id === window.currentUser.id);  // âœ… ë‚´ ëŒ“ê¸€?
        let editedLabel = "";
         if (c.updated_date && c.updated_date !== c.created_date) {
            const uds = new Date(c.updated_date).toLocaleString();
         editedLabel = ` <span class="text-xs text-gray-400">(ìˆ˜ì •ë¨ ${uds})</span>`;
         // editedLabel = ' <span class="text-xs text-gray-400">(ìˆ˜ì •ë¨)</span>';
         }
        const el = document.createElement('div');
        el.className = 'rounded-xl border p-4';

        el.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="flex items-center gap-3">
              <img src="${c.author_avatar || 'https://cdn-icons-png.flaticon.com/512/3177/3177440.png'}"
                   class="w-7 h-7 rounded-full object-cover" alt="">
              <div>
                <div class="text-sm font-medium text-gray-700">${c.username || '-'}</div>
                 <div class="text-xs text-gray-500">${ts}${editedLabel}</div>
              </div>
            </div>

            ${isMine ? `
<div class="flex gap-2">
    <button class="edit-comment text-xs text-blue-600 hover:underline" data-id="${c.id}">
      ìˆ˜ì •
    </button>
              <button class="delete-comment text-xs text-red-600 hover:underline" data-id="${c.id}">
                ì‚­ì œ
              </button>
              </div>
            ` : ''}
          </div>

          <p class="mt-2 text-gray-800 whitespace-pre-line">${c.content}</p>
        `;
                // âœ… ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸
       const editBtn = el.querySelector('.edit-comment');
if (editBtn) {
  editBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const cid = Number(editBtn.dataset.id);

    // ì´ë¯¸ ìˆ˜ì • ì¤‘ì¸ ëŒ“ê¸€ì´ ìˆìœ¼ë©´ ë¬´ì‹œ
    if (el.querySelector('.edit-area')) return;

    // ê¸°ì¡´ ë‚´ìš© ìˆ¨ê¸°ê³  textarea ì‚½ì…
    const contentP = el.querySelector('p');
    const originalText = contentP.textContent;
    contentP.style.display = 'none';

    const editDiv = document.createElement('div');
    editDiv.className = 'edit-area mt-2';
    editDiv.innerHTML = `
      <textarea class="w-full border rounded-lg p-2 text-sm">${originalText}</textarea>
      <div class="mt-2 flex gap-2 justify-end">
        <button class="save-edit bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-blue-700">ë³€ê²½í•˜ê¸°</button>
        <button class="cancel-edit border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">ì·¨ì†Œ</button>
      </div>
    `;
    contentP.after(editDiv);

    // ë³€ê²½í•˜ê¸° ë²„íŠ¼
    editDiv.querySelector('.save-edit').addEventListener('click', async () => {
      const newContent = editDiv.querySelector('textarea').value.trim();
      if (!newContent || newContent === originalText) {
        alert('ë‚´ìš©ì„ ë³€ê²½í•´ì£¼ì„¸ìš”.');
        return;
      }
      try {
        const fd = new FormData();
        fd.append('content', newContent);
        const resp = await fetch(`/comments/${cid}`, { method: 'PUT', body: fd });
        const body = await resp.json().catch(() => ({}));
        if (!resp.ok) {
          alert(body.detail || 'ìˆ˜ì • ì‹¤íŒ¨');
          return;
        }
        await loadComments();
      } catch {
        alert('ìˆ˜ì • ì‹¤íŒ¨');
      }
    });

    // ì·¨ì†Œ ë²„íŠ¼
    editDiv.querySelector('.cancel-edit').addEventListener('click', () => {
      editDiv.remove();
      contentP.style.display = '';
    });
  });
}


        // âœ… ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
        const delBtn = el.querySelector('.delete-comment');
        if (delBtn) {
          delBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const cid = Number(delBtn.dataset.id);
            if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
            try {
              const resp = await fetch(`/comments/${cid}`, { method: 'DELETE' });
              const body = await resp.json().catch(() => ({}));
              if (!resp.ok) {
                alert(body.detail || 'ì‚­ì œ ì‹¤íŒ¨');
                return;
              }
              // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ + ëŒ“ê¸€ ìˆ˜ ê°±ì‹ 
              await loadComments();
            } catch {
              alert('ì‚­ì œ ì‹¤íŒ¨');
            }
          });
        }

        box.appendChild(el);
      });

      // ìƒë‹¨ ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
      document.getElementById('statComments').textContent = `ğŸ’¬ ${data.comments.length}`;
    } catch {
      box.innerHTML = `<div class="text-sm text-red-500">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
    }
  }

    document.getElementById('commentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      fd.append('post_id', postId);
      try {
        const r = await fetch('/comment', { method: 'POST', body: fd });
        const data = await r.json();
        if (!r.ok) {
          alert(data.detail || 'ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨');
          return;
        }
        e.target.reset();
        await loadComments();
      } catch {
        alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨');
      }
    });

    (async function init(){
      await renderHeader();
      await loadPost();
      await loadComments();
    })();
  </script>
</body>
</html>
