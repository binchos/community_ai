<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>게시글 상세 · Community</title>
  <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-gray-50 min-h-screen">
  <!-- 헤더 -->
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
    <div class="max-w-4xl mx-auto px-4 h-14 flex items-center justify-between">
      <h1 class="text-lg font-bold text-gray-900 cursor-pointer" onclick="location.href='index.html'">Community</h1>
      <div id="navRight" class="flex items-center gap-2"></div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-8">
    <div class="mb-4">
      <button class="text-sm text-gray-600 hover:text-blue-700" onclick="location.href='index.html'">← 홈으로</button>

    </div>

    <!-- 본문 카드 -->
    <article class="bg-white rounded-2xl border p-6">
    <div id="meta" class="flex items-center gap-3">
  <img id="authorAvatar" class="w-8 h-8 rounded-full object-cover" alt="author avatar">
  <div>
    <div id="author" class="text-sm font-medium text-gray-800">-</div>
    <div id="createdAt" class="text-xs text-gray-500">-</div>
  </div>
</div>


      <h2 id="title" class="mt-2 text-2xl font-bold text-gray-900 break-words">제목</h2>
 <div id="content" class="mt-6 whitespace-pre-line text-gray-800"></div>
        <div id="imageArea" class="mt-3"></div>
      <!-- 상단 통계 / 좋아요 버튼 -->
      <div class="mt-3 flex items-center justify-between">
        <div class="flex items-center gap-4 text-sm text-gray-500">
          <span id="statLikes">👍 0</span>
          <span id="statComments">💬 0</span>
          <span id="statViews">👁️ 0</span>
        </div>
     <div class="flex items-center gap-2">
    <button id="likeBtn"
            class="rounded-xl px-4 py-2 text-sm font-medium border hover:bg-gray-50">
      👍 좋아요
    </button>

    <!-- ✅ 삭제 버튼: 기본 hidden, 작성자일 때만 보이게 -->
    <button id="deleteBtn"
            class="hidden rounded-xl px-4 py-2 text-sm font-medium border text-red-600 hover:bg-red-50">
      🗑 삭제
    </button>
  </div>
      </div>


    </article>

    <!-- 댓글 -->
    <section class="mt-6 bg-white rounded-2xl border p-6">
      <h3 class="text-lg font-semibold">댓글</h3>

      <!-- 댓글 작성 -->
      <form id="commentForm" class="mt-4">
        <textarea name="content"
                  class="w-full rounded-xl border px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  rows="3" placeholder="댓글을 입력하세요" required></textarea>
        <div class="mt-3 flex justify-end">
          <button class="rounded-xl bg-blue-600 text-white px-4 py-2 font-medium hover:bg-blue-700">
            등록
          </button>
        </div>
      </form>

      <!-- 목록 -->
      <div id="comments" class="mt-4 space-y-3"></div>
    </section>
  </main>

  <script>
        window.addEventListener("pageshow", (e) => {
    if (e.persisted) location.reload();
  });
    // 공통: 헤더 유저 표시
    async function renderHeader() {
      const nav = document.getElementById('navRight');
      try {
        const res = await fetch('/users/me');
        if (!res.ok) {
          nav.innerHTML = `
            <button class="rounded-xl border px-3 py-1.5 text-sm hover:bg-gray-50" onclick="location.href='login.html'">로그인</button>
            <button class="rounded-xl bg-gray-900 text-white px-3 py-1.5 text-sm hover:bg-black" onclick="location.href='register.html'">회원가입</button>
          `;
          return;
        }
        const { user } = await res.json();
        window.currentUser = user;

        const avatar = user.avatar_url || 'https://cdn-icons-png.flaticon.com/512/3177/3177440.png';
        nav.innerHTML = `
          <button onclick="location.href='mypage.html'" class="flex items-center gap-2 rounded-full border px-2 py-1.5 hover:bg-gray-50">
            <img src="${avatar}" class="w-7 h-7 rounded-full object-cover">
            <span class="text-sm font-medium text-gray-800">${user.username}</span>
          </button>
        `;
      } catch {
        nav.innerHTML = `<button class="rounded-xl border px-3 py-1.5 text-sm" onclick="location.href='login.html'">로그인</button>`;
      }
    }

    // URL 파라미터에서 id 추출
    const params = new URLSearchParams(location.search);
    const postId = Number(params.get('id'));
    if (!postId) location.replace('index.html');

    // 상세 불러오기
    async function loadPost() {
      // 조회수 +1 (백엔드에 라우트 필요: POST /posts/{id}/view)
      try { await fetch(`/posts/${postId}/view`, { method: 'POST' }); } catch {}

      // 게시글 가져오기 (권장 라우트: GET /posts/{id} -> like_count, comment_count, view_count, liked 포함)
      let post;
      try {
        const r = await fetch(`/posts/${postId}`);
        if (r.ok) {
          post = await r.json();
        }
      } catch {}

      // 만약 위 라우트가 없다면, /posts 전체에서 찾아서 최소 정보라도 렌더 (폴백)
      if (!post?.id) {
        try {
          const r2 = await fetch('/posts');
          if (r2.ok) {
            const data = await r2.json();
            post = (data.posts || []).find(p => p.id === postId);
            // liked 정보는 없음 (버튼 기본상태로)
          }
        } catch {}
      }

      if (!post?.id) {
        document.querySelector('main').innerHTML =
          `<div class="max-w-4xl mx-auto bg-white rounded-xl border p-6 text-center text-red-500">게시글을 불러오지 못했습니다.</div>`;
        return;
      }

      // 렌더
      // 제목/본문
        document.getElementById('title').textContent = post.title || '-';
        document.getElementById('content').textContent = post.content || '';
        const imageArea = document.getElementById('imageArea');
if (post.image_url) {
  imageArea.innerHTML = `
    <img src="${post.image_url}"
         alt=""
         class="w-full rounded-xl border object-contain max-h-[28rem]">
  `;
} else {
  imageArea.innerHTML = ''; // 이미지가 없으면 비움
}
// 아바타/이름/시간 — 홈 목록과 동일한 형태
        const avatar = post.author_avatar || 'https://cdn-icons-png.flaticon.com/512/3177/3177440.png';
        const avatarEl = document.getElementById('authorAvatar');
        if (avatarEl) {
  avatarEl.src = avatar;
  avatarEl.alt = post.username || 'author';
}
        document.getElementById('author').textContent =
  post.username || '-';
        document.getElementById('createdAt').textContent =
  post.created_date ? new Date(post.created_date).toLocaleString() : '';

      document.getElementById('statLikes').textContent    = `👍 ${post.like_count ?? 0}`;
      document.getElementById('statComments').textContent = `💬 ${post.comment_count ?? 0}`;
      document.getElementById('statViews').textContent    = `👁️ ${post.view_count ?? 0}`;

      // 좋아요 버튼 상태
      setLikeBtn(!!post.liked);
      const deleteBtn = document.getElementById('deleteBtn');
        if (window.currentUser && window.currentUser.username && post.username && window.currentUser.username === post.username) {deleteBtn.classList.remove('hidden');
        deleteBtn.onclick = async () => {
            if (!confirm('정말 삭제할까요? 되돌릴 수 없습니다.')) return;
            try {
                const r = await fetch(`/posts/${postId}`, { method: 'DELETE' });
                const data = await r.json().catch(()=>({}));
                if (!r.ok) {
                    alert(data.detail || '삭제 실패');
                    return;
                }
                alert(data.message || '삭제되었습니다.');
                location.href = 'index.html';
                } catch {
                alert('삭제 실패');
                }
            };
        }
      // 버튼 핸들러
      document.getElementById('likeBtn').onclick = async () => {
        try {
          // 권장 라우트: POST /posts/{id}/like (토글) -> { liked:bool, like_count:int }
          const r = await fetch(`/posts/${postId}/like`, { method: 'POST' });
          if (!r.ok) return;
          const data = await r.json();
          setLikeBtn(!!data.liked);
          document.getElementById('statLikes').textContent = `👍 ${data.like_count ?? (post.like_count ?? 0)}`;
        } catch {}
      };
    }

    function setLikeBtn(liked) {
      const btn = document.getElementById('likeBtn');
      if (liked) {
        btn.classList.remove('border','hover:bg-gray-50');
        btn.classList.add('bg-blue-600','text-white','hover:bg-blue-700');
        btn.textContent = '👍 좋아요 취소';
      } else {
        btn.classList.add('border','hover:bg-gray-50');
        btn.classList.remove('bg-blue-600','text-white','hover:bg-blue-700');
        btn.textContent = '👍 좋아요';
      }
    }

    // 댓글
    async function loadComments() {
    const box = document.getElementById('comments');
    box.innerHTML = `<div class="text-sm text-gray-400">불러오는 중…</div>`;
    try {
      const r = await fetch(`/comments/${postId}`);
      if (!r.ok) throw 0;
      const data = await r.json();

      if (!data.comments?.length) {
        box.innerHTML = `<div class="text-sm text-gray-400">첫 댓글을 남겨보세요.</div>`;
        // 상단 개수도 0으로
        document.getElementById('statComments').textContent = `💬 0`;
        return;
      }

      box.innerHTML = '';
      data.comments.forEach(c => {
        const ts = c.created_date ? new Date(c.created_date).toLocaleString() : '';
        const isMine = window.currentUser && (c.user_id === window.currentUser.id);  // ✅ 내 댓글?
        let editedLabel = "";
         if (c.updated_date && c.updated_date !== c.created_date) {
            const uds = new Date(c.updated_date).toLocaleString();
         editedLabel = ` <span class="text-xs text-gray-400">(수정됨 ${uds})</span>`;
         // editedLabel = ' <span class="text-xs text-gray-400">(수정됨)</span>';
         }
        const el = document.createElement('div');
        el.className = 'rounded-xl border p-4';

        el.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="flex items-center gap-3">
              <img src="${c.author_avatar || 'https://cdn-icons-png.flaticon.com/512/3177/3177440.png'}"
                   class="w-7 h-7 rounded-full object-cover" alt="">
              <div>
                <div class="text-sm font-medium text-gray-700">${c.username || '-'}</div>
                 <div class="text-xs text-gray-500">${ts}${editedLabel}</div>
              </div>
            </div>

            ${isMine ? `
<div class="flex gap-2">
    <button class="edit-comment text-xs text-blue-600 hover:underline" data-id="${c.id}">
      수정
    </button>
              <button class="delete-comment text-xs text-red-600 hover:underline" data-id="${c.id}">
                삭제
              </button>
              </div>
            ` : ''}
          </div>

          <p class="mt-2 text-gray-800 whitespace-pre-line">${c.content}</p>
        `;
                // ✅ 수정 버튼 이벤트
       const editBtn = el.querySelector('.edit-comment');
if (editBtn) {
  editBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const cid = Number(editBtn.dataset.id);

    // 이미 수정 중인 댓글이 있으면 무시
    if (el.querySelector('.edit-area')) return;

    // 기존 내용 숨기고 textarea 삽입
    const contentP = el.querySelector('p');
    const originalText = contentP.textContent;
    contentP.style.display = 'none';

    const editDiv = document.createElement('div');
    editDiv.className = 'edit-area mt-2';
    editDiv.innerHTML = `
      <textarea class="w-full border rounded-lg p-2 text-sm">${originalText}</textarea>
      <div class="mt-2 flex gap-2 justify-end">
        <button class="save-edit bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-blue-700">변경하기</button>
        <button class="cancel-edit border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">취소</button>
      </div>
    `;
    contentP.after(editDiv);

    // 변경하기 버튼
    editDiv.querySelector('.save-edit').addEventListener('click', async () => {
      const newContent = editDiv.querySelector('textarea').value.trim();
      if (!newContent || newContent === originalText) {
        alert('내용을 변경해주세요.');
        return;
      }
      try {
        const fd = new FormData();
        fd.append('content', newContent);
        const resp = await fetch(`/comments/${cid}`, { method: 'PUT', body: fd });
        const body = await resp.json().catch(() => ({}));
        if (!resp.ok) {
          alert(body.detail || '수정 실패');
          return;
        }
        await loadComments();
      } catch {
        alert('수정 실패');
      }
    });

    // 취소 버튼
    editDiv.querySelector('.cancel-edit').addEventListener('click', () => {
      editDiv.remove();
      contentP.style.display = '';
    });
  });
}


        // ✅ 삭제 버튼 이벤트
        const delBtn = el.querySelector('.delete-comment');
        if (delBtn) {
          delBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const cid = Number(delBtn.dataset.id);
            if (!confirm('댓글을 삭제할까요?')) return;
            try {
              const resp = await fetch(`/comments/${cid}`, { method: 'DELETE' });
              const body = await resp.json().catch(() => ({}));
              if (!resp.ok) {
                alert(body.detail || '삭제 실패');
                return;
              }
              // 목록 새로고침 + 댓글 수 갱신
              await loadComments();
            } catch {
              alert('삭제 실패');
            }
          });
        }

        box.appendChild(el);
      });

      // 상단 댓글 수 업데이트
      document.getElementById('statComments').textContent = `💬 ${data.comments.length}`;
    } catch {
      box.innerHTML = `<div class="text-sm text-red-500">댓글을 불러오지 못했습니다.</div>`;
    }
  }

    document.getElementById('commentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      fd.append('post_id', postId);
      try {
        const r = await fetch('/comment', { method: 'POST', body: fd });
        const data = await r.json();
        if (!r.ok) {
          alert(data.detail || '댓글 등록 실패');
          return;
        }
        e.target.reset();
        await loadComments();
      } catch {
        alert('댓글 등록 실패');
      }
    });

    (async function init(){
      await renderHeader();
      await loadPost();
      await loadComments();
    })();
  </script>
</body>
</html>
